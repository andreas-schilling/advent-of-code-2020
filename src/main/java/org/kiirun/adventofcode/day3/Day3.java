package org.kiirun.adventofcode.day3;

import com.google.common.base.CharMatcher;
import com.google.common.collect.Table;
import com.google.common.collect.TreeBasedTable;
import reactor.core.publisher.Flux;
import reactor.function.TupleUtils;
import reactor.util.function.Tuples;

import java.util.ArrayList;
import java.util.List;

public class Day3 {
	private static final String[] INPUT = {
			".#..#.....#....##..............",
			"...#.#...#...#.#..........#....",
			"#...###...#.#.....#.##.#.#...#.",
			"#.....#.#...##....#...#...#....",
			"##.......##.#.....#........##.#",
			"#..#....#......#..#......#...#.",
			"#..#......#.......#............",
			"##...#.#..#...#........#....##.",
			"#.#.#...#...#..#........#....#.",
			".......#...........##......#...",
			"##.##.##......#..#............#",
			"..#.###..#..............#......",
			".##..#.....#......#.#..........",
			"........#.........#....#....###",
			"#..........#........#.#.#......",
			"...##.....#..####.###..#.##....",
			"....#...###............#..#....",
			"...#.#...#.#...#..#.#........##",
			".....#...#.............#..#....",
			"....#.#.#.##.....##.##....#....",
			"..#....#............#.##.##..#.",
			".#..#..#................#...###",
			"#..###.#..##..#............#...",
			".......#.#....#.##.#.##........",
			"##...###.#....#...........###.#",
			"...#.#....#..####.........#....",
			"....##........#.#.#.###........",
			"#...#..#.....#....##..#.##...#.",
			"##....................##..#....",
			".#....##...........##...##...#.",
			".#.#..#.........#.........#.#.#",
			"#.#..#.....#.#..#..#..#.#......",
			"...#.............#......#....##",
			"....#.#.......#....#...#.##...#",
			"#.#.#..###..........#...#......",
			"......#.....#..#..#.......##..#",
			".#......#......#.....#...#.....",
			"......#..#......#.#............",
			"..#............#..#....#.#.....",
			".....#..##.......#...##.###.#.#",
			".....#........##....#.#...##..#",
			"..........##.#..#.#...#..#....#",
			"#.#.#.#.##...................#.",
			".....#....##.....#..#...#..#...",
			"...#....#.............#....#.#.",
			".........#.##..##..............",
			"#...#.#....#..#...#.......#....",
			".#...#......#.##.#...#.#..###..",
			"..#.#.#......#..#...##..##.##..",
			".........#.....#......##....##.",
			"...###.......#..#........#.....",
			"...#....#...#.#.#......##....#.",
			".#.....#......#...##.##..#.....",
			"..#.##...#....####...##........",
			"..#.#.###....#..##.......##....",
			".....#....##...#......#.......#",
			".#....#......#..............#..",
			".......#.#......#..#....#.#.#..",
			".......#.#.........###....#....",
			".#...#.......#.#..#..####....#.",
			"..#...#.#......#..#.##.###..#..",
			"..##.........#............#.#.#",
			"#.........##.##.........#.###..",
			"...#....#.......#..#..##.......",
			".#....##........##.......#..#..",
			"...#.....#.#.##.#.#.....##.....",
			".#.#........#.......#.#..#..#..",
			".....####..##.##.#.#....#......",
			"..#.##.#.#.#....###..#....#.#..",
			"..##..#.#......##.#..#.........",
			"....#..#.#.##.......#...##.....",
			"....###.....#..###...#....###.#",
			"..#....#.......#......#...##..#",
			"..#..##......#....#.###..#..##.",
			"..#..#...............#.#.#.....",
			"...##...#.#..#.#...#......#....",
			"#....#...#.#.#.#.#....#....#...",
			"....##...#....#.....##..#.....#",
			"......##.....#...##..#.......#.",
			"......###......#....#.##..#....",
			".....#........#........#...#..#",
			".#..##.....##....#.#......#.#..",
			"#..#.#.....#........#......#.#.",
			".#..#.##.....#####.#....#.#....",
			"....##........#..........#.#...",
			".......#.....#.......#...#.#...",
			".#....#...##.###....#.#......#.",
			"#...#...........##.#...........",
			"#...##.......#..#........#.#..#",
			".....#..##..###....#.#.#....#..",
			"..#..#.....#............#.#....",
			"............#......#.....#.....",
			".#..#.....##.........#....###.#",
			"#.........#....#....#.#..#...#.",
			"##.#...##....#..#...#.#...#....",
			"....###..##...................#",
			"....##...#......#...#.#...#...#",
			"#....#....###..........#...#..#",
			".....##.#....###.###....#..###.",
			"#.....#...........#...........#",
			"##..###.##........#..#.#..#.#..",
			".##...#..#.......#.#....#.....#",
			"......##..#..#.......#.#...##..",
			"......#..#..#.#...###..#.#....#",
			"#.##.#..#......#...##........##",
			".....#..........##.....#...#...",
			"........#....##......#......#.#",
			"..#..#.#...#.#.#.......#......#",
			".#....#........#............#..",
			"......##.....#...#.............",
			"#......##..#.......##....##.#..",
			".....#..#..#...#.......#..#....",
			"...#..##.#..#.#....##.....#..##",
			"......#...#.#...#.#......###.#.",
			".#.#...#.....#..###.....#......",
			"#..####.#....#.......##...#....",
			".##.......#.....#.........#....",
			"#......##.#...............#....",
			".######.#...##...#...#...#..##.",
			"....#...####....##.#..#...##...",
			".#...................#.#..#..#.",
			".#.#....##...#...#.#..#.#.#.#..",
			"......#......#........##.#...#.",
			"##..#...#..#.............##.#..",
			"#.............#..........#.#...",
			"...##.....#.............#......",
			"......###.....#................",
			"#.#.#....#..##.#.....#.........",
			".#.#........#.........#.#.##.#.",
			"......#...##...#.#.....#....#..",
			"#...#.........##.##.#..........",
			"#..............#..#.......##...",
			"#...#......#.#......#...#....#.",
			"...#...#........#.#......#.###.",
			"##.....#...#.#..#..#..#.......#",
			"..#.##..##.........#...##.##...",
			"#....#....#.....#..........#...",
			"#.####..#..###.....#..#..#.....",
			"..#.....#.##.##..####....#.#.#.",
			"...#.#....#...#.......#..#.....",
			"......###...#.#..#..#..........",
			".........#..#.....#.#.##......#",
			".......#.#....##.....##.#..#.#.",
			".#..#.#..#......##.###...##..#.",
			"....###...........#.....#....#.",
			".#.##.....#..#.....#......##...",
			"#..##....#..........#.##.##..#.",
			".###.#.#..#.#.....#..##....#.#.",
			"..##.#....#.....##..#..........",
			"##........#...#..#........###.#",
			"#...#...........##.......#.#...",
			"...###.....##.#....#...#...#...",
			"......#....#.#.......###....#..",
			"...#...#.......##.......###.#..",
			"..............#.#..........##..",
			"#.#....###..#..#.........#.....",
			".###.#.......#.....#....#.#....",
			".....###...#.#..#.#.......#....",
			".........#.##.#......#.#..#....",
			".......#....#....#.#....#..##.#",
			"...............#...##.#..#.#..#",
			".....##........#..##...........",
			".##.#..#....#..#.#...#.........",
			".#.#..##.#..#......#....#.#...#",
			"##....#.......##...........#...",
			"..#...#.............#.#....#..#",
			"..#......#..#.....#...##.....#.",
			"....##...#.#...##...#..##......",
			".....#..#..........#...........",
			"..##....#..#.#....#..#........#",
			".###....#.....#.#....#..##.....",
			"#.......##.......#..#..#....#.#",
			".##..#...........#..##..##..#..",
			".#.................#...#....#..",
			".######.......#............##..",
			".#.........#......##.#.#.#.#.#.",
			".#.......#...#...#....###....#.",
			"....#...##.#.#...#.....#.#..#..",
			".#..#..#...#.....###....#......",
			"...#.##.###........#.....##....",
			"..#....#.#.#..........#..#..#..",
			"......#.....#...#..#..##..#.#..",
			"#.#.......##.......#....#.....#",
			"..#...#..#.#....#.##.##........",
			"..#....#..##..#..##......#.....",
			"#....#..##.....#....###........",
			"##...#......#..###.#.....#.....",
			"#..###....#...#...#...#......##",
			".....###....#......#..#..#...#.",
			".##......#.......##...#........",
			"....#.#.....##.....#.....#.....",
			"...##.#.....#..##...#...##.#...",
			"..#...#.#....#....#...##.......",
			"......#....#..#....#.#.........",
			"..........#.#.#...##....#......",
			"...#....................#..#...",
			"...#....###....#..#.....#.....#",
			"..#....#....#..#.#..##.#...#...",
			"..#.##....##.....#.#........#..",
			"#.....###..#.#.#...#..#....#...",
			"........#..#.#..#........##....",
			".##....#................##.#.##",
			"..##...#.#.#.....##..#....#....",
			"....#..#....#..#........#..##..",
			"...#...##....#....#..##......#.",
			"##........#...#.....#.....#...#",
			".#......#....##...#.........##.",
			"##........#...#.....#..#...#.#.",
			"...##..#..#.....#..###.#..#....",
			"....#..#..............#.......#",
			".......#.##...#......#.###.....",
			"#........##..##....#.#.#.......",
			"#.#..##.#.......#..##.....###..",
			".....##...#..#.....#...........",
			"...#..#..#......#...#.#........",
			".#....#....#.#.....#.....#....#",
			"...#..#...#..#.##.#......#.#.#.",
			"..##....#..#..#.....#....#....#",
			"...#....#.##.#..#.###......#...",
			".......#..#.....#.......#..#...",
			"..###.#####..#..##.#.........#.",
			"...#.......##...#.#..#.#......#",
			"....#...#.###..#..........#....",
			"...........#...#..##........#..",
			".......#...#....#....#.#..#....",
			".........#..........#...#....##",
			".##.........##..#.......##.#...",
			"........#......###...##...#.#.#",
			"#.#...##.##...........#...#.#..",
			".....###...#..##......#..#.....",
			"#.#.....#.#....##..........#..#",
			"#..#.......#.#.........####....",
			"#.#...#.....#........#.....#..#",
			".....#..#.#.###.....#.#.###....",
			".###..#......##..#..#..........",
			"#....#.#......#...#.##......#..",
			"..#.........##.#.....#.........",
			"...#....#.....##.#..#..##.#..#.",
			"##.....#.#..#.#....#......#....",
			"....###.#.....#.......#..#.#...",
			"#.....##.....##...........#....",
			"..........#..#......#.##...#...",
			"#...#.###....##....#.###..###..",
			"##........#.#...#..#.........#.",
			"##........##.......#.....###...",
			".##....###........#..##...#...#",
			"......#..##....##.....#..#.#...",
			".....#..##..#.......#.......#..",
			"......#....#.......##.#........",
			".#.####.#..#......#..#.........",
			".##..#....#...##.#....#....#...",
			"..#..#..#####.........#...#....",
			"....#.....#.#.#.#...#.#......#.",
			"....#...#.#..#.##...#...#......",
			"..#...#...#...#...#..#.#.##..#.",
			"..#......#.#.#.##.##.##..#.....",
			"#..###......#.##...#....#.##.#.",
			".#.#.......##..##....##...##.#.",
			".##......##....##.#.......#...#",
			"..#...#...................#....",
			".#...#.......######.....#.#..##",
			"......#.##.....#.#.............",
			"...........##.#........#..#....",
			"#.............#.#.....#....##..",
			"#...........#...#..###.....#...",
			"....#.......#.#..#..#.#........",
			"......#...##.......#..##....#..",
			"......#.##.##..#........#.#...#",
			".#..#...##...................#.",
			".#.............#...#.#.#.#...#.",
			".........#.....#........#.#....",
			"#..#...#.............##.#.....#",
			"...#.#....#...##............#..",
			"..#...#.##.###.#.....#......##.",
			"...#.#..###...#.#............#.",
			"...#....#........#.#...........",
			".#......#.#.#.........#.#....#.",
			"....#..#......#.##.....#.#.....",
			"..#..###....#....#.........###.",
			"#..#.#....##.#....#.##..#......",
			"#..#.....#.#.....##..#.##......",
			"......#...#.#.............#..#.",
			"#.#....#.#..#...#......#.#.....",
			"..#.........#.#....#...#.......",
			".#..#.#...#....#...#......#...#",
			".......#........#.#..#..#...#..",
			"..##.#......#..##.##.#..#..#...",
			".##...#....##.....#.....#...##.",
			"#.....##.#....#.#......##..#...",
			".......#.#..#...#.......#.#...#",
			"..#...#.......#...#..##........",
			"#....##..#...#..#.#......#..#.#",
			"##.#....#....#....#...#..#.##..",
			"###........#.#..#..#......#....",
			".#......#.....#....#.#..#...#..",
			".#.....#.....#...##.......#..##",
			"#..##.#..#..........#..........",
			"...#.##.........#.#.##.#.......",
			".#..#...............#...#.#.#..",
			".....#.#.....#...####..#.....#.",
			".#....#.##..##...#...##.#...#.#",
			"....#......##...#.#.#.....#.##.",
			"#...#..#.#...#.#.....##...#....",
			"..#..#....##..###......#..#....",
			".........#......##.....##....#.",
			".......#....#...#........###...",
			".....#..#..#...#...#......#....",
			"..#..#...#.....#.....###..#.###",
			"............#.#..#..#....#.....",
			"...#..#...###.......#.......#..",
			"#.........#........#.....##....",
			".#.#........#.....#........###.",
			"....#.##.#...#.#.#.....#....#..",
			".##...#..#.......#.#...........",
			"##...#.##...#...........#.....#",
			"##....#.#.....##..#.......#....",
			"##....#...#....#..#.......####.",
			"......#...#..#.....#.#....#...#",
			".......#.....#..###............",
			"#.#.#..#.....#.............#..#",
			".#..#.....##.....#...#.......##",
			"..#.##........##...........#.#.",
			"....##.#..###.#.........#...##."};

	private static final CharMatcher TREE = CharMatcher.is('#');

	public static void main(final String[] args) {
		final Area area = new Area(INPUT);
		System.out.println(traverseAndCount(area, 3, 1));

		Flux.just(Tuples.of(1, 1), Tuples.of(3, 1), Tuples.of(5, 1), Tuples.of(7, 1), Tuples.of(1, 2))
				.map(TupleUtils.function((slopeX, slopeY) -> traverseAndCount(area, slopeX, slopeY)))
				.reduceWith(() -> 1L, (a, b) -> a * b)
				.subscribe(System.out::println);
	}

	private static Long traverseAndCount(final Area area, final int slopeX, final int slopeY) {
		final List<Character> visitedElements = new ArrayList<>();
		int posX = 0;
		int posY = 0;
		while (posY <= area.getHeight() - 1) {
			visitedElements.add(area.elementAt(posX, posY));
			posX += slopeX;
			posY += slopeY;
		}
		return visitedElements.stream().filter(TREE).count();
	}

	private static class Area {
		private final Table<Integer, Integer, Character> map = TreeBasedTable.create();

		private final int width;

		private final int height;

		public Area(final String[] rawMap) {
			width = rawMap[0].length();
			height = rawMap.length;
			for (int row = 0; row < rawMap.length; row++) {
				for (int col = 0; col < rawMap[row].length(); col++) {
					map.put(row, col, rawMap[row].charAt(col));
				}
			}
		}

		public int getWidth() {
			return width;
		}

		public int getHeight() {
			return height;
		}

		public Character elementAt(final int x, final int y) {
			return map.get(y, x % width);
		}
	}
}
